name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write
  actions: read

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Download artifact from CI
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh run download \
            --repo ${{ github.repository }} \
            --name final-dist \
            --dir artifact \
            -w ci.yml \
            -b main

      - name: Create draft release and upload artifacts
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create "${{ github.ref_name }}" \
            --draft \
            --generate-notes \
            --title "${{ github.ref_name }}" \
            -R ${{ github.repository }}

          find artifact -name "*.zip" -exec gh release upload "${{ github.ref_name }}" {} --clobber \;
